<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <title>Reeha - Şahsi Keşif Günlüğü</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* Üst Bar Tasarımı */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 80px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
            z-index: 100; display: flex; align-items: center; padding: 0 25px;
        }

        .back-btn {
            color: white; text-decoration: none; letter-spacing: 2px; 
            font-size: 11px; opacity: 0.6; transition: 0.3s; margin-right: 30px;
        }
        .back-btn:hover { opacity: 1; }

        /* Premium Fotoğraf Pop-up */
        .mapboxgl-popup-content {
            background: rgba(0,0,0,0.95) !important;
            color: white !important;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0 !important;
            padding: 5px !important;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        .popup-img { width: 100%; max-width: 450px; height: auto; display: block; }

        /* Premium Minyatür Fotoğraf Pin (Marker) */
        .custom-marker {
            width: 50px; height: 50px;
            border: 2px solid white;
            background-size: cover;
            background-position: center;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }
        .custom-marker:hover { transform: scale(1.2) rotate(3deg); z-index: 10; box-shadow: 0 0 25px rgba(255,255,255,0.6); }
        .custom-marker::after {
            content: ''; position: absolute; bottom: -10px; left: 50%;
            transform: translateX(-50%);
            border-left: 7px solid transparent; border-right: 7px solid transparent;
            border-top: 10px solid white;
        }

        /* Arama Kutusu Özelleştirme */
        .mapboxgl-ctrl-geocoder {
            background-color: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(10px);
            box-shadow: none !important; border-radius: 0 !important;
        }
        .mapboxgl-ctrl-geocoder--input { color: white !important; font-family: serif; }
        .mapboxgl-ctrl-bottom-right, .mapboxgl-ctrl-bottom-left { display: none; }
    </style>
</head>
<body>

    <div class="top-bar">
        <a href="index.html" class="back-btn">← ANA SAYFA</a>
        <div id="geocoder"></div>
    </div>

    <input type="file" id="photoInput" accept="image/*" style="display:none;">

    <div id="map"></div>

<script>
    // Senin Token Bilgin
    mapboxgl.accessToken = 'pk.eyJ1IjoiYWRlbTk5MTciLCJhIjoiY21rMDF6YXNjNmNtYzNlczU5YTUyYXUzMCJ9.mjaJaz3MfODoSZrL2wVKJw';
    
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-v9', 
        projection: 'globe', 
        zoom: 2.2,
        center: [28.97, 41.00],
        antialias: true
    });

    // Arama Motoru
    const geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        marker: false,
        placeholder: 'BİR KONUM ARA...',
        zoom: 16
    });
    document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

    let selectedCoords = null;
    let savedMarkers = JSON.parse(localStorage.getItem('myMarkers')) || [];

    // TIKLAMA MANTIĞI: Fotoğrafa tıklayınca fotoğrafı açar, boş yere tıklayınca yükleme yapar.
    map.on('click', (e) => {
        // Eğer bir fotoğraf pinine (marker) tıklandıysa dosya seçiciyi açma
        if (e.originalEvent.target.closest('.custom-marker')) return;
        
        // Sadece harita zeminine tıklandıysa dosya seçiciyi aç
        if (e.originalEvent.target.className.includes('mapboxgl-canvas')) {
            selectedCoords = e.lngLat;
            const input = document.getElementById('photoInput');
            input.value = ''; // Aynı dosyayı üst üste seçebilmek için
            input.click();
        }
    });

    // DOSYA SEÇİLDİĞİNDE
    document.getElementById('photoInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            const imageUrl = event.target.result;
            const markerId = Date.now(); // Silme işlemi için benzersiz kimlik
            
            const newMarkerData = {
                id: markerId,
                lng: selectedCoords.lng,
                lat: selectedCoords.lat,
                img: imageUrl
            };
            
            addMarkerToMap(newMarkerData);
            savedMarkers.push(newMarkerData);
            localStorage.setItem('myMarkers', JSON.stringify(savedMarkers));
        };
        reader.readAsDataURL(file);
    });

    // HARİTAYA PİN EKLEME FONKSİYONU
    function addMarkerToMap(data) {
        const el = document.createElement('div');
        el.className = 'custom-marker';
        el.style.backgroundImage = `url(${data.img})`;

        // Tıklayınca açılacak fotoğraf penceresi
        const popup = new mapboxgl.Popup({ offset: 35, maxWidth: 'none' })
            .setHTML(`<img src="${data.img}" class="popup-img">`);

        const marker = new mapboxgl.Marker(el)
            .setLngLat([data.lng, data.lat])
            .setPopup(popup)
            .addTo(map);

        // SAĞ TIKLA SİLME (Premium Özellik)
        el.addEventListener('contextmenu', (e) => {
            e.preventDefault(); // Sağ tık menüsünü engelle
            if (confirm("Bu anıyı haritadan silmek istiyor musun?")) {
                marker.remove();
                savedMarkers = savedMarkers.filter(m => m.id !== data.id);
                localStorage.setItem('myMarkers', JSON.stringify(savedMarkers));
            }
        });
    }

    // SAYFA YÜKLENDİĞİNDE HAFIZADAKİ FOTOĞRAFLARI GETİR
    map.on('load', () => {
        savedMarkers.forEach(markerData => addMarkerToMap(markerData));
    });

    // OTOMATİK DÜNYA DÖNÜŞÜ (Müdahale edilince durur)
    let isSpinning = true;
    const userInteracted = () => { isSpinning = false; };
    map.on('mousedown', userInteracted);
    map.on('wheel', userInteracted);
    map.on('touchstart', userInteracted);
    geocoder.on('result', userInteracted);

    function rotateGlobe() {
        if (isSpinning && map.getZoom() < 5) {
            const center = map.getCenter();
            center.lng -= 0.15;
            map.easeTo({ center, duration: 0, easing: (n) => n });
        }
    }
    
    map.on('moveend', () => { if (isSpinning) rotateGlobe(); });
    map.on('style.load', () => {
        map.setFog({ 'color': '#000', 'high-color': '#000', 'space-color': '#000', 'horizon-blend': 0.02 });
        rotateGlobe();
    });
</script>

</body>
</html>
