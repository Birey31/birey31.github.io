<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Reeha - Şahsi Keşif Günlüğü</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* Üst Bar */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 80px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
            z-index: 100; display: flex; align-items: center; padding: 0 25px;
        }

        .back-btn {
            color: white; text-decoration: none; font-family: serif;
            letter-spacing: 2px; font-size: 11px; opacity: 0.6; transition: 0.3s;
            margin-right: 30px;
        }

        /* Fotoğraf Baloncuğu */
        .mapboxgl-popup-content {
            background: #000 !important; color: white !important;
            border: 1px solid #333; border-radius: 0 !important; padding: 10px !important;
        }
        .popup-img { width: 100%; max-width: 250px; height: auto; border: 1px solid #222; }

        /* Pin Tasarımı */
        .custom-marker {
            width: 12px; height: 12px; background: #fff; border-radius: 50%;
            cursor: pointer; box-shadow: 0 0 15px #fff;
        }

        /* Arama Kutusu */
        .mapboxgl-ctrl-geocoder { background-color: rgba(255, 255, 255, 0.05) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; border-radius: 0 !important; }
        .mapboxgl-ctrl-geocoder--input { color: white !important; }
        .mapboxgl-ctrl-bottom-right, .mapboxgl-ctrl-bottom-left { display: none; }
    </style>
</head>
<body>

<div class="top-bar">
    <a href="index.html" class="back-btn">← ANA SAYFA</a>
    <div id="geocoder"></div>
</div>

<input type="file" id="photoInput" accept="image/*" style="display:none;">

<div id="map"></div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYWRlbTk5MTciLCJhIjoiY21rMDF6YXNjNmNtYzNlczU5YTUyYXUzMCJ9.mjaJaz3MfODoSZrL2wVKJw';
    
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-v9', 
        projection: 'globe', 
        zoom: 2,
        center: [28.97, 41.00],
        antialias: true
    });

    const geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        marker: false,
        placeholder: 'KONUM ARA VE TIKLAYIP FOTO EKLE...',
        zoom: 16
    });

    document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

    let selectedCoords = null;
    let savedMarkers = JSON.parse(localStorage.getItem('myMarkers')) || [];

    // HARİTAYA TIKLAMA OLAYI
    map.on('click', (e) => {
        // Arama kutusuna veya butona tıklanmadığından emin olalım
        if (e.originalEvent.target.id !== "") return; 
        
        selectedCoords = e.lngLat;
        document.getElementById('photoInput').click(); 
    });

    // DOSYA SEÇİLDİĞİNDE ÇALIŞAN KISIM
    document.getElementById('photoInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            const imageUrl = event.target.result;
            const newMarker = { lng: selectedCoords.lng, lat: selectedCoords.lat, img: imageUrl };
            
            // 1. Haritaya ekle
            addMarkerToMap(newMarker);
            
            // 2. Hafızaya kaydet
            savedMarkers.push(newMarker);
            localStorage.setItem('myMarkers', JSON.stringify(savedMarkers));
        };
        reader.readAsDataURL(file);
    });

    // PİNİ HARİTAYA KOYAN FONKSİYON
    function addMarkerToMap(data) {
        const el = document.createElement('div');
        el.className = 'custom-marker';

        const popup = new mapboxgl.Popup({ offset: 25 })
            .setHTML(`<img src="${data.img}" class="popup-img"><p style="text-align:center; font-size:9px;">${new Date().toLocaleDateString()}</p>`);

        new mapboxgl.Marker(el)
            .setLngLat([data.lng, data.lat])
            .setPopup(popup)
            .addTo(map);
    }

    // SAYFA AÇILDIĞINDA ESKİ PİNLERİ YÜKLE
    map.on('load', () => {
        savedMarkers.forEach(m => addMarkerToMap(m));
    });

    // OTOMATİK DÖNÜŞ VE DURDURMA
    let isSpinning = true;
    map.on('mousedown', () => isSpinning = false);
    geocoder.on('result', () => isSpinning = false);

    function rotateGlobe() {
        if (isSpinning && map.getZoom() < 5) {
            const center = map.getCenter();
            center.lng -= 0.15;
            map.easeTo({ center, duration: 0, easing: (n) => n });
        }
    }
    map.on('moveend', () => { if (isSpinning) rotateGlobe(); });
    map.on('style.load', () => {
        map.setFog({ 'color': '#000', 'high-color': '#000', 'space-color': '#000' });
        rotateGlobe();
    });
</script>

</body>
</html>
